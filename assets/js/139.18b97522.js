(window.webpackJsonp=window.webpackJsonp||[]).push([[139],{431:function(e,t,r){"use strict";r.r(t);var s=r(4),a=Object(s.a)({},(function(){var e=this,t=e._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h2",{attrs:{id:"react16架构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#react16架构"}},[e._v("#")]),e._v(" React16架构")]),e._v(" "),t("blockquote",[t("p",[t("a",{attrs:{href:"https://react.iamkasong.com/preparation/newConstructure.html#react16%E6%9E%B6%E6%9E%84",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://react.iamkasong.com/preparation/newConstructure.html#react16架构"),t("OutboundLink")],1)])]),e._v(" "),t("p",[e._v("React16架构可以分为三层：")]),e._v(" "),t("ul",[t("li",[e._v("Scheduler（调度器）—— 调度任务的优先级，高优任务优先进入"),t("strong",[e._v("Reconciler")])]),e._v(" "),t("li",[e._v("Reconciler（协调器）—— 负责找出变化的组件")]),e._v(" "),t("li",[e._v("Renderer（渲染器）—— 负责将变化的组件渲染到页面上")])]),e._v(" "),t("p",[e._v("可以看到，相较于React15，React16中新增了"),t("strong",[e._v("Scheduler（调度器）")]),e._v("，让我们来了解下他。")]),e._v(" "),t("h3",{attrs:{id:"scheduler-调度器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#scheduler-调度器"}},[e._v("#")]),e._v(" Scheduler（调度器）")]),e._v(" "),t("p",[e._v("既然我们以浏览器是否有剩余时间作为任务中断的标准，那么我们需要一种机制，当浏览器有剩余时间时通知我们。")]),e._v(" "),t("p",[e._v("其实部分浏览器已经实现了这个API，这就是"),t("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestIdleCallback",target:"_blank",rel:"noopener noreferrer"}},[e._v("requestIdleCallback (opens new window)"),t("OutboundLink")],1),e._v("。但是由于以下因素，"),t("code",[e._v("React")]),e._v("放弃使用：")]),e._v(" "),t("ul",[t("li",[e._v("浏览器兼容性")]),e._v(" "),t("li",[e._v("触发频率不稳定，受很多因素影响。比如当我们的浏览器切换tab后，之前tab注册的"),t("code",[e._v("requestIdleCallback")]),e._v("触发的频率会变得很低")])]),e._v(" "),t("p",[e._v("基于以上原因，"),t("code",[e._v("React")]),e._v("实现了功能更完备的"),t("code",[e._v("requestIdleCallback")]),e._v("polyfill，这就是"),t("strong",[e._v("Scheduler")]),e._v("。除了在空闲时触发回调的功能外，"),t("strong",[e._v("Scheduler")]),e._v("还提供了多种调度优先级供任务设置。")]),e._v(" "),t("blockquote",[t("p",[t("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/scheduler/README.md",target:"_blank",rel:"noopener noreferrer"}},[e._v("Scheduler (opens new window)"),t("OutboundLink")],1),e._v("是独立于"),t("code",[e._v("React")]),e._v("的库")])]),e._v(" "),t("h3",{attrs:{id:"reconciler-协调器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#reconciler-协调器"}},[e._v("#")]),e._v(" Reconciler（协调器）")]),e._v(" "),t("p",[e._v("我们知道，在React15中"),t("strong",[e._v("Reconciler")]),e._v("是递归处理虚拟DOM的。让我们看看"),t("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1673",target:"_blank",rel:"noopener noreferrer"}},[e._v("React16的Reconciler (opens new window)"),t("OutboundLink")],1),e._v("。")]),e._v(" "),t("p",[e._v("我们可以看见，更新工作从递归变成了可以中断的循环过程。每次循环都会调用"),t("code",[e._v("shouldYield")]),e._v("判断当前是否有剩余时间。")]),e._v(" "),t("div",{staticClass:"language-js extra-class"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/** @noinline */")]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("function")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("workLoopConcurrent")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Perform work until Scheduler asks us to yield")]),e._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("while")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("workInProgress "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("!==")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("null")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("&&")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("!")]),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("shouldYield")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    workInProgress "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[e._v("performUnitOfWork")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("workInProgress"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),t("p",[e._v("那么React16是如何解决中断更新时DOM渲染不完全的问题呢？")]),e._v(" "),t("p",[e._v("在React16中，"),t("strong",[e._v("Reconciler")]),e._v("与"),t("strong",[e._v("Renderer")]),e._v("不再是交替工作。当"),t("strong",[e._v("Scheduler")]),e._v("将任务交给"),t("strong",[e._v("Reconciler")]),e._v("后，"),t("strong",[e._v("Reconciler")]),e._v("会为变化的虚拟DOM打上代表增/删/更新的标记，类似这样：")]),e._v(" "),t("div",{staticClass:"language-js extra-class"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("export")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" Placement "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/*             */")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("0b0000000000010")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("export")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" Update "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/*                */")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("0b0000000000100")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("export")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" PlacementAndUpdate "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/*    */")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("0b0000000000110")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("export")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" Deletion "),t("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/*              */")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[e._v("0b0000000001000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),t("blockquote",[t("p",[e._v("全部的标记见"),t("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactSideEffectTags.js",target:"_blank",rel:"noopener noreferrer"}},[e._v("这里(opens new window)"),t("OutboundLink")],1)])]),e._v(" "),t("p",[e._v("整个"),t("strong",[e._v("Scheduler")]),e._v("与"),t("strong",[e._v("Reconciler")]),e._v("的工作都在内存中进行。只有当所有组件都完成"),t("strong",[e._v("Reconciler")]),e._v("的工作，才会统一交给"),t("strong",[e._v("Renderer")]),e._v("。")]),e._v(" "),t("blockquote",[t("p",[e._v("你可以在"),t("a",{attrs:{href:"https://zh-hans.reactjs.org/docs/codebase-overview.html#fiber-reconciler",target:"_blank",rel:"noopener noreferrer"}},[e._v("这里 (opens new window)"),t("OutboundLink")],1),e._v("看到"),t("code",[e._v("React")]),e._v("官方对React16新"),t("strong",[e._v("Reconciler")]),e._v("的解释")])]),e._v(" "),t("h3",{attrs:{id:"renderer-渲染器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#renderer-渲染器"}},[e._v("#")]),e._v(" Renderer（渲染器）")]),e._v(" "),t("p",[t("strong",[e._v("Renderer")]),e._v("根据"),t("strong",[e._v("Reconciler")]),e._v("为虚拟DOM打的标记，同步执行对应的DOM操作。")])])}),[],!1,null,null,null);t.default=a.exports}}]);