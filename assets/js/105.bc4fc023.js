(window.webpackJsonp=window.webpackJsonp||[]).push([[105],{397:function(t,s,a){"use strict";a.r(s);var e=a(4),r=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("上一节我们提到"),s("code",[t._v("Scheduler")]),t._v("与"),s("code",[t._v("React")]),t._v("是两套"),s("code",[t._v("优先级")]),t._v("机制。在"),s("code",[t._v("React")]),t._v("中，存在多种使用不同"),s("code",[t._v("优先级")]),t._v("的情况，比如：")]),t._v(" "),s("p",[t._v("注：以下例子皆为"),s("code",[t._v("Concurrent Mode")]),t._v("开启情况")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("过期任务或者同步任务使用"),s("code",[t._v("同步")]),t._v("优先级")])]),t._v(" "),s("li",[s("p",[t._v("用户交互产生的更新（比如点击事件）使用高优先级")])]),t._v(" "),s("li",[s("p",[t._v("网络请求产生的更新使用一般优先级")])]),t._v(" "),s("li",[s("p",[s("code",[t._v("Suspense")]),t._v("使用低优先级")])])]),t._v(" "),s("p",[s("code",[t._v("React")]),t._v("需要设计一套满足如下需要的"),s("code",[t._v("优先级")]),t._v("机制：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("可以表示"),s("code",[t._v("优先级")]),t._v("的不同")])]),t._v(" "),s("li",[s("p",[t._v("可能同时存在几个同"),s("code",[t._v("优先级")]),t._v("的"),s("code",[t._v("更新")]),t._v("，所以还得能表示"),s("code",[t._v("批")]),t._v("的概念")])]),t._v(" "),s("li",[s("p",[t._v("方便进行"),s("code",[t._v("优先级")]),t._v("相关计算")])])]),t._v(" "),s("p",[t._v("为了满足如上需求，"),s("code",[t._v("React")]),t._v("设计了"),s("code",[t._v("lane")]),t._v("模型。接下来我们来看"),s("code",[t._v("lane")]),t._v("模型如何满足以上3个条件。")]),t._v(" "),s("h2",{attrs:{id:"表示优先级的不同"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#表示优先级的不同"}},[t._v("#")]),t._v(" 表示优先级的不同")]),t._v(" "),s("p",[t._v("想象你身处赛车场。")]),t._v(" "),s("img",{attrs:{src:t.$withBase("/img/lane.jpeg"),alt:"30sec"}}),t._v(" "),s("p",[t._v("不同的赛车疾驰在不同的赛道。内圈的赛道总长度更短，外圈更长。某几个临近的赛道的长度可以看作差不多长。")]),t._v(" "),s("p",[s("code",[t._v("lane")]),t._v("模型借鉴了同样的概念，使用31位的二进制表示31条赛道，位数越小的赛道"),s("code",[t._v("优先级")]),t._v("越高，某些相邻的赛道拥有相同"),s("code",[t._v("优先级")]),t._v("。")]),t._v(" "),s("p",[t._v("如下：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("NoLanes")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                        */")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000000000000000000000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("NoLane")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                          */")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000000000000000000000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("SyncLane")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                        */")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000000000000000000001")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("SyncBatchedLane")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                 */")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000000000000000000010")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("InputDiscreteHydrationLane")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*      */")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000000000000000000100")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("InputDiscreteLanes")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                    */")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000000000000000011000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("InputContinuousHydrationLane")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*           */")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000000000000000100000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("InputContinuousLanes")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                  */")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000000000000011000000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("DefaultHydrationLane")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*            */")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000000000000100000000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("DefaultLanes")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                   */")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000000000111000000000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("TransitionHydrationLane")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                */")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000000001000000000000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("TransitionLanes")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                       */")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000001111111110000000000000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("RetryLanes")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                            */")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000011110000000000000000000000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("SomeRetryLane")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                  */")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000010000000000000000000000000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("SelectiveHydrationLane")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*          */")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000100000000000000000000000000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" NonIdleLanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                                 */")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000111111111111111111111111111")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("IdleHydrationLane")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*               */")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0001000000000000000000000000000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("IdleLanes")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                             */")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0110000000000000000000000000000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("OffscreenLane")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                   */")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b1000000000000000000000000000000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("blockquote",[s("p",[t._v("你可以在"),s("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberLane.js#L77-L107",target:"_blank",rel:"noopener noreferrer"}},[t._v("这里"),s("OutboundLink")],1),t._v("看到"),s("code",[t._v("lane")]),t._v("的定义")])]),t._v(" "),s("p",[t._v("其中，同步优先级占用的赛道为第一位：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("SyncLane")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lane "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                        */")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000000000000000000001")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("从"),s("code",[t._v("SyncLane")]),t._v("往下一直到"),s("code",[t._v("SelectiveHydrationLane")]),t._v("，赛道的"),s("code",[t._v("优先级")]),t._v("逐步降低。")]),t._v(" "),s("h2",{attrs:{id:"表示-批-的概念"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#表示-批-的概念"}},[t._v("#")]),t._v(" 表示“批”的概念")]),t._v(" "),s("p",[t._v("可以看到其中有几个变量占用了几条赛道，比如：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("InputDiscreteLanes")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                    */")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000000000000000011000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("DefaultLanes")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                   */")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000000000000000111000000000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("TransitionLanes")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/*                       */")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0b0000000001111111110000000000000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("这就是"),s("code",[t._v("批")]),t._v("的概念，被称作"),s("code",[t._v("lanes")]),t._v("（区别于"),s("code",[t._v("优先级")]),t._v("的"),s("code",[t._v("lane")]),t._v("）。")]),t._v(" "),s("p",[t._v("其中"),s("code",[t._v("InputDiscreteLanes")]),t._v("是“用户交互”触发更新会拥有的"),s("code",[t._v("优先级")]),t._v("范围。")]),t._v(" "),s("p",[s("code",[t._v("DefaultLanes")]),t._v("是“请求数据返回后触发更新”拥有的"),s("code",[t._v("优先级")]),t._v("范围。")]),t._v(" "),s("p",[s("code",[t._v("TransitionLanes")]),t._v("是"),s("code",[t._v("Suspense")]),t._v("、"),s("code",[t._v("useTransition")]),t._v("、"),s("code",[t._v("useDeferredValue")]),t._v("拥有的"),s("code",[t._v("优先级")]),t._v("范围。")]),t._v(" "),s("p",[t._v("这其中有个细节，越低"),s("code",[t._v("优先级")]),t._v("的"),s("code",[t._v("lanes")]),t._v("占用的位越多。比如"),s("code",[t._v("InputDiscreteLanes")]),t._v("占了2个位，"),s("code",[t._v("TransitionLanes")]),t._v("占了9个位。")]),t._v(" "),s("p",[t._v("原因在于：越低"),s("code",[t._v("优先级")]),t._v("的"),s("code",[t._v("更新")]),t._v("越容易被打断，导致积压下来，所以需要更多的位。相反，最高优的同步更新的"),s("code",[t._v("SyncLane")]),t._v("不需要多余的"),s("code",[t._v("lanes")]),t._v("。")]),t._v(" "),s("h2",{attrs:{id:"方便进行优先级相关计算"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#方便进行优先级相关计算"}},[t._v("#")]),t._v(" 方便进行优先级相关计算")]),t._v(" "),s("p",[t._v("既然"),s("code",[t._v("lane")]),t._v("对应了二进制的位，那么"),s("code",[t._v("优先级")]),t._v("相关计算其实就是位运算。")]),t._v(" "),s("p",[t._v("比如：")]),t._v(" "),s("p",[t._v("计算"),s("code",[t._v("a")]),t._v("、"),s("code",[t._v("b")]),t._v("两个"),s("code",[t._v("lane")]),t._v("是否存在交集，只需要判断"),s("code",[t._v("a")]),t._v("与"),s("code",[t._v("b")]),t._v("按位与的结果是否为"),s("code",[t._v("0")]),t._v("：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("includesSomeLane")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("a")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Lane"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("b")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Lane")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" b"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" NoLanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("计算"),s("code",[t._v("b")]),t._v("这个"),s("code",[t._v("lanes")]),t._v("是否是"),s("code",[t._v("a")]),t._v("对应的"),s("code",[t._v("lanes")]),t._v("的子集，只需要判断"),s("code",[t._v("a")]),t._v("与"),s("code",[t._v("b")]),t._v("按位与的结果是否为"),s("code",[t._v("b")]),t._v("：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isSubsetOfLanes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("set")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("subset")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Lane")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("set "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" subset"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" subset"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("将两个"),s("code",[t._v("lane")]),t._v("或"),s("code",[t._v("lanes")]),t._v("的位合并只需要执行按位或操作：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mergeLanes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("a")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Lane"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("b")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Lane")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lanes "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" a "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" b"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("从"),s("code",[t._v("set")]),t._v("对应"),s("code",[t._v("lanes")]),t._v("中移除"),s("code",[t._v("subset")]),t._v("对应"),s("code",[t._v("lane")]),t._v("（或"),s("code",[t._v("lanes")]),t._v("），只需要对"),s("code",[t._v("subset")]),t._v("的"),s("code",[t._v("lane")]),t._v("（或"),s("code",[t._v("lanes")]),t._v("）执行按位非，结果再对"),s("code",[t._v("set")]),t._v("执行按位与。")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("removeLanes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("set")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lanes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("subset")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lanes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Lane")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" Lanes "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" set "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~")]),t._v("subset"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("blockquote",[s("p",[t._v("更多位运算参考"),s("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/Bitwise_Operators",target:"_blank",rel:"noopener noreferrer"}},[t._v("MDN"),s("OutboundLink")],1)])]),t._v(" "),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("p",[t._v("这就是"),s("code",[t._v("React")]),t._v("的优先级模型"),s("code",[t._v("lane")]),t._v("模型。")]),t._v(" "),s("p",[t._v("至此，我们已经了解"),s("code",[t._v("Fiber")]),t._v("架构、"),s("code",[t._v("更新")]),t._v("的"),s("code",[t._v("优先级")]),t._v("、"),s("code",[t._v("Scheduler")]),t._v("的实现、"),s("code",[t._v("lane")]),t._v("模型。从下一节开始，我们会逐步讲解"),s("code",[t._v("Concurrent Mode")]),t._v("的各种应用。")])])}),[],!1,null,null,null);s.default=r.exports}}]);